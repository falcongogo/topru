# TOPる – 麻雀オーラス逆転条件計算ツール

麻雀のオーラスで逆転するために必要な条件を計算するツールです。

## 機能

- 現在の点数状況から逆転に必要な条件を計算
- 直撃ロン、他家放銃ロン、ツモの3つのパターンを表示
- 積み棒・供託棒を考慮した計算
- 親・子の違いを考慮した計算
- **スリムスコア28S画像からの自動点数入力**

### 画像からの自動点数入力

本ツールのコア機能の一つです。スマホなどで撮影した、家庭用麻雀卓「スリムスコア28S」の点数表示部分の画像をアップロードすることで、自動で点数を読み取ります。

**自動検出アルゴリズム**:
- **スクリーン検出**: 画像全体からHSV色空間を利用して青いLCDスクリーン領域を検出します。
- **幾何学補正**: 検出したスクリーンの4点の座標から、`cv2.getPerspectiveTransform`を用いて傾きや歪みを補正し、長方形のスクリーン画像に変換します。
- **せん断補正**: 7セグメントデジタルの僅かな傾き（せん断）をハフ変換 (`cv2.HoughLinesP`) で検出し、補正します。
- **7セグメント認識**: 補正後の画像から各プレイヤーの点数領域を切り出し、さらに5桁の数字に分割します。各数字画像について、7つのセグメント領域の輝度をチェックし、どのセグメントが点灯しているかのパターンから0-9の数値を認識します。

**デバッグ機能**:
- 「🔧 デバッグモード」を有効にすると、上記の各処理ステップの途中経過画像（スクリーン検出、傾き補正後など）を画面上で確認できます。

## 必要なもの

- Python 3.8+
- `pip`

## インストール & 実行

1.  **リポジトリをクローンします**
    ```bash
    git clone https://github.com/your-username/toppuru.git
    cd toppuru
    ```

2.  **Pythonライブラリをインストールします**
    ```bash
    pip install -r requirements.txt
    ```

3.  **アプリケーションを実行します**
    ```bash
    streamlit run app.py
    ```

## テスト

### 全テストの実行

プロジェクトのルートディレクトリから以下のコマンドを実行します。

```bash
python -m unittest discover tests
```
または
```bash
python tests/run_tests.py
```

### 個別テストの実行

`tests`ディレクトリ内の特定のテストファイルを指定して実行することも可能です。

```bash
# 例: calculate_conditionsのテストを実行
python -m unittest tests.test_calculate_conditions
```

## ファイル構成

リファクタリングにより、責務に応じたファイル分割が行われています。

- `app.py`: Streamlitアプリケーションのメインファイル。全体制御を担当。
- `ui.py`: StreamlitのUIコンポーネント（画面描画ロジック）を格納。
- `calculate_conditions.py`: 逆転条件の計算ロジック。
- `points_lookup.py`: 点数から必要な役を逆引きするロジック。
- `image_processor.py`: 画像からの点数読み取り処理ロジック。
- `config.py`: アプリケーション全体の設定値や定数を格納。
- `points_table.py`: 麻雀の点数表データ。
- `styles.css`: UIのスタイルシート。
- `requirements.txt`: Pythonの依存ライブラリリスト。
- `debug/`: （ユーザーにより作成される）デバッグ画像用のディレクトリ。
- `tests/`:
  - `test_*.py`: 各モジュールに対応する単体テスト。
  - `run_tests.py`: テストスイートを実行するためのスクリプト。
  - `test_data/`: テスト用の画像データ。
